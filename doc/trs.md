# Техническое задание: Приложение для изучения латышского языка

## 1. Обзор проекта

### 1.1 Цель проекта
Создание веб-приложения для изучения латышского языка русскоговорящими пользователями с использованием интерактивных карточек, интеллектуального анализа текста и автоматического перевода.

### 1.2 Основные задачи
- Анализ латышского текста с извлечением ключевых слов и фраз
- Создание карточек для запоминания с базовыми и текстовыми формами слов
- Интерактивное чтение с подсказками при наведении
- Автоматический перевод текста на русский язык
- Редактирование и управление карточками
- Экспорт/импорт данных для сохранения прогресса

### 1.3 Целевая аудитория
Русскоговорящие пользователи, изучающие латышский язык на начальном и среднем уровне.

### 1.4 Архитектура проекта
**Текущая архитектура**: Модульная компонентная архитектура с четким разделением ответственности

**Основные модули:**
- **`client/src/App.tsx`** (~150 строк) - Главный компонент приложения
- **`client/src/types/index.ts`** - Центральные TypeScript типы и интерфейсы
- **`client/src/components/`** - UI компоненты (Header, Footer, Views)
- **`client/src/hooks/`** - Кастомные React хуки для бизнес-логики
- **`client/src/utils/`** - Утилитарные функции (cardUtils, textUtils)

**Преимущества текущей архитектуры:**
- Отличная тестируемость каждого модуля
- Легкость поддержки и развития функциональности
- Переиспользование компонентов и хуков
- Четкое разделение UI и бизнес-логики
- Полная типизация TypeScript

**Архитектурные слои:**
1. **Presentation Layer** (компоненты) - отображение UI и взаимодействие с пользователем
2. **Business Logic Layer** (хуки) - обработка данных и состояния приложения
3. **Utility Layer** (utils) - вспомогательные функции и алгоритмы
4. **Data Layer** (types) - типизация и структуры данных

### 1.5 История развития проекта
**Версия 1.0** (Project5_9.txt): Монолитная архитектура, один файл App.tsx ~2400 строк
**Версия 2.0** (Project6_1.txt): Модульная архитектура с компонентами и хуками

**Ключевые достижения декомпозиции:**
- ✅ Сокращение основного файла на 94% (с 2400 до 150 строк)
- ✅ Создание 8 специализированных компонентов
- ✅ Внедрение 3 кастомных хуков для бизнес-логики
- ✅ Разделение утилит на логические модули
- ✅ Создание централизованной системы типов
- ✅ Добавление интеллектуальной обработки ошибок API

**Планы дальнейшего развития:**
- Добавление юнит-тестов для всех компонентов
- Внедрение E2E тестирования
- Оптимизация производительности крупных текстов
- Добавление поддержки других языков

## 2. Функциональные требования

### 2.1 Режим Text (Ввод текста)
**Описание**: Основная точка входа для обработки латышского текста

**Функции**:
- Ввод латышского текста (до 5000 символов)
- Счетчик символов с визуальной индикацией превышения лимита
- Кнопка "Process (Sentence-by-Sentence)" для запуска обработки
- Валидация текста перед обработкой

**Технические детали**:
- Блокировка обработки при превышении лимита символов
- Автоматическое разделение на предложения
- Обработка каждого предложения с контекстом (6 предложений вокруг)

### 2.2 Режим Flashcards (Карточки с множественными контекстами)
**Описание**: Изучение слов с объединенными контекстами для исключения дубликатов

**Принцип работы**:
- **Одна карточка на `base_form`** - нет дубликатов даже если слово встречается в разных предложениях
- **Множественные контексты** - показ всех случаев использования слова

**Функции**:
- Отображение карточек с flip-анимацией
- Лицевая сторона: базовая форма слова (`base_form`)
- Оборотная сторона: 
  - Перевод базовой формы (`base_translation`)
  - **Настраиваемое количество контекстов**:
    - По умолчанию: первый контекст
    - Опционально: все контексты для полного изучения
  - Каждый контекст включает:
    - Оригинальную фразу с выделением изучаемого слова
    - Перевод фразы (`phrase_translation`)

**Структура отображения контекстов (настраиваемая)**:
```jsx
// Количество контекстов из настроек
const contextsToShow = settings.display.contextsToShow === 'all' 
  ? card.contexts.length 
  : Math.min(settings.display.contextsToShow, card.contexts.length);

{card.contexts.slice(0, contextsToShow).map((ctx, index) => (
  <div key={ctx.original_phrase} className="context-block">
    {contextsToShow > 1 && (
      <div className="context-number">Context {index + 1}:</div>
    )}
    <div className="font-medium">
      {highlightWordInPhrase(ctx.original_phrase, card.base_form, ctx.text_forms)}
    </div>
    <div className="text-gray-600">{ctx.phrase_translation}</div>
  </div>
))}

{card.contexts.length > contextsToShow && (
  <div className="more-contexts-hint">
    +{card.contexts.length - contextsToShow} more contexts available
  </div>
)}
```

**Навигация и управление**:
- Навигация стрелками ← → между уникальными карточками
- Переворот карточки стрелками ↑ ↓ или кликом
- Скрытие карточки клавишей 'h'
- Показ только видимых карточек
- Индикатор позиции по уникальным `base_form`

**Real-time обновления**:
- **Постепенное появление карточек** по мере обработки чанков
- **Мгновенная доступность** для изучения после первых 2-3 карточек
- **Автоматическое объединение** дубликатов в реальном времени

### 2.3 Режим Reading (Интерактивное чтение с контекстными подсказками)
**Описание**: Чтение латышского текста с точными контекстными переводами

**Принцип работы**:
- **Контекстно-зависимые подсказки** - перевод формы слова именно из данного предложения
- **Поиск по контекстам** - для слова `mammai` в предложении "Viņas mammai šodien ir dzimšanas diena" показывается перевод именно из этого контекста, а не общий перевод base_form

**Функции**:
- Отображение оригинального текста с постепенным добавлением интерактивности
- **Real-time активация** интерактивных элементов по мере обработки чанков
- Интерактивные элементы:
  - Фразы (выделение синим цветом)
  - Отдельные слова (выделение желтым цветом)
- Легенда с объяснением цветовой схемы
- Контекстные подсказки (tooltips):
  - Задержка 2 секунды перед показом
  - Визуальная обратная связь (пунктирная рамка)
  - Желтый фон при показе перевода
  - **Точный перевод формы слова из конкретного предложения**

**Алгоритм контекстного поиска переводов**:
```javascript
const findContextualTranslation = (word, currentSentence) => {
  // 1. Найти карточку по base_form или text_forms
  const card = findCardByWord(word);
  if (!card) return null;
  
  // 2. Найти правильный контекст по предложению
  const context = card.contexts.find(ctx => 
    ctx.original_phrase.includes(currentSentence)
  );
  
  // 3. Вернуть перевод из правильного контекста
  return context ? context.phrase_translation : card.base_translation;
};
```

**Поэтапная активация**:
- Изначально показ статичного текста
- По мере обработки чанков - активация интерактивных элементов для обработанных предложений
- Индикация необработанных участков (например, серым цветом)

### 2.4 Режим Translation (Составной перевод)
**Описание**: Отображение полного перевода, составленного из фрагментов предложений

**Принцип работы**:
- **НЕ отдельный запрос** к Claude API для полного перевода
- **Склеивание переводов** из уже обработанных `phrase_translation` всех контекстов
- **Экономия ресурсов** API и времени обработки

**Функции**:
- Заголовок "Translation (Russian)"
- **Постепенное формирование перевода** по мере обработки чанков
- Отображение составного русского перевода из всех `phrase_translation`
- **Real-time обновления** - добавление новых переведенных предложений
- Чистый интерфейс без дополнительных элементов

**Алгоритм составления перевода**:
```javascript
// Собираем переводы предложений по порядку
const assembleTranslation = (contexts) => {
  return contexts
    .map(ctx => ctx.phrase_translation)
    .filter(translation => translation && translation.length > 0)
    .join(' ');
};
```

**Индикация процесса**:
- Показ уже переведенных предложений
- Placeholder для ещё не обработанных частей
- Финальное форматирование после завершения всех чанков

### 2.5 Режим Edit (Редактирование карточек)
**Описание**: Полноэкранная таблица для управления карточками

**Функции**:
- Заголовок с общим количеством карточек
- Кнопка "+ Add New Card" (добавляет карточки ВВЕРХУ списка)
- Поиск по всем полям карточек
- Таблица с 8 колонками:
  1. VISIBLE (checkbox для показа/скрытия)
  2. TEXT FORM (`front`)
  3. TEXT TRANSLATION (`back`)
  4. BASE FORM (`base_form`)
  5. BASE TRANSLATION (`base_translation`)
  6. ORIGINAL PHRASE (`original_phrase`)
  7. PHRASE TRANSLATION (`phrase_translation`)
  8. ACTIONS (кнопка удаления)
- Пагинация (25 карточек на страницу)
- Автоматическое сохранение изменений
- Информация о текущей странице

**Функции управления карточками**:
- Создание новых карточек
- Редактирование всех полей
- Переключение видимости
- Удаление карточек
- Поиск и фильтрация

### 2.8 Система настроек приложения
**Описание**: Конфигурация поведения обработки и отображения

**Настройки обработки текста**:
- **Размер чанков** (dropdown):
  - "2-3 предложения" (по умолчанию, этап 1)
  - "Динамическое разбиение по токенам (300 max)" (этап 2)
- **Количество контекстов в карточках** (number input):
  - Значения: 1, 2, 3, 4, 5... или "все"
  - По умолчанию: 1
- **Автосохранение прогресса** (checkbox):
  - Включено по умолчанию
  - Сохранение каждые 5 обработанных чанков

**Настройки интерфейса**:
- **Язык интерфейса**: английский (на данном этапе)
- **Тема**: светлая (на данном этапе)
- **Автоматический экспорт**: при завершении обработки

**Структура настроек**:
```javascript
interface AppSettings {
  chunking: {
    mode: 'sentences' | 'tokens';           // тип разбиения
    sentencesPerChunk: number;              // 2-3 предложения
    maxTokensPerChunk: number;              // 300 для токенов
  };
  display: {
    contextsToShow: number | 'all';         // количество контекстов
    autoSaveInterval: number;               // интервал автосохранения
    enableAutoExport: boolean;              // автоэкспорт при завершении
  };
  processing: {
    enableProgressResume: boolean;          // возобновление прогресса
    maxRetries: number;                     // попытки при ошибках
  };
}
```

**Доступ к настройкам**:
- Кнопка "⚙️ Settings" в header рядом с import/export
- Модальное окно с разделами настроек
- Применение настроек мгновенно (для UI) или с перезапуском обработки
**Описание**: Сохранение и восстановление данных

**Функции экспорта**:
- Сохранение всех данных в JSON формате
- Включение всех карточек (в том числе скрытых)
- Метаданные: timestamp, version
- Автоматическое скачивание файла

**Функции импорта**:
- Загрузка JSON файлов
- Восстановление полной функциональности без API
- Валидация структуры данных
- Обратная совместимость

### 2.7 Стриминговая обработка с возобновлением
**Описание**: Интеллектуальный анализ латышского текста с восстановлением после сбоев

**Поэтапное развитие чанкинга**:

**Этап 1 (текущий)**: 
- Фиксированные чанки по 2 предложения
- Простая и надежная реализация
- Настройка `settings.chunking.sentencesPerChunk = 2`

**Этап 2 (будущий)**:
- Динамическое разбиение по токенам (max 300)
- Оптимальное использование контекста Claude
- Переключение в настройках между режимами

**Архитектура восстановления**:
```javascript
interface ProcessingState {
  sessionId: string;                    // уникальный ID сессии
  totalChunks: number;
  processedChunks: number;
  lastProcessedIndex: number;
  failedChunks: number[];               // индексы неудачных чанков
  isCompleted: boolean;
  chunks: ProcessingChunk[];
}

interface ProcessingChunk {
  index: number;
  text: string;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  cards: Flashcard[];
  translationSegment: string;
  error?: string;
  attempts: number;
}
```

**Функции восстановления**:
- **Автосохранение состояния** каждые 5 обработанных чанков
- **Обнаружение незавершенной сессии** при загрузке приложения
- **Предложение продолжения**: "Found incomplete processing session. Continue from chunk 15/23?"
- **Повторная обработка неудачных чанков** с экспоненциальным backoff
- **Graceful degradation**: пропуск критически неудачных чанков с уведомлением

**События SSE с восстановлением**:
```javascript
// Начало/возобновление обработки
{ type: 'session:started', payload: { sessionId, totalChunks, resumeFromIndex } }

// Обработан чанк с сохранением состояния
{ type: 'chunk:completed', payload: { chunkIndex, cards, state: ProcessingState } }

// Ошибка с планом восстановления
{ type: 'chunk:failed', payload: { chunkIndex, error, retryIn: 5000 } }

// Полное завершение или аварийное прекращение
{ type: 'session:finished', payload: { completedChunks, failedChunks, totalCards } }
```

**UX восстановления**:
- **Уведомления о прогрессе**: "Saved progress: 15/23 chunks completed"
- **Предупреждения при закрытии**: "Processing in progress. Close anyway?"
- **Опции восстановления**: "Continue", "Restart", "Save & Exit"
- **Статистика сессии**: "Session resumed. 8 chunks remaining."

## 3. Нефункциональные требования

### 3.1 Производительность
- Время отклика интерфейса: < 100мс
- Обработка предложений: 800мс между запросами к API
- Загрузка приложения: < 3 секунды
- Плавные анимации (60 FPS)

### 3.2 Безопасность
- Проксирование API ключей через backend
- Валидация входных данных
- Обработка ошибок без раскрытия технических деталей

### 3.3 Юзабилити
- Интуитивный интерфейс
- Клавиатурные сочетания
- Визуальная обратная связь
- Подробные сообщения об ошибках
- Адаптивный дизайн

### 3.4 Надежность
- Устойчивость к сбоям API
- Валидация данных
- Fallback механизмы
- Автоматическое сохранение состояния

## 4. Технические спецификации

### 4.1 Frontend
**Технологический стек**:
- React 18.2.0 с TypeScript
- Vite для сборки
- Tailwind CSS для стилизации
- Lucide React для иконок

**Архитектурные требования**:
- **Модульная архитектура** с четким разделением ответственности
- **Component-based подход** - каждый компонент отвечает за одну функцию
- **Custom hooks** для изоляции бизнес-логики от UI
- **Утилитарные функции** для переиспользуемых алгоритмов
- Использование `React.useState` (без деструктуризации)
- Шрифт: `Noto Sans Display` для всех текстов
- Основной цвет: `#6A9BCC`
- Обязательные проверки на `undefined`

**Структура компонентов**:
```
client/src/
├── App.tsx                 # Главный компонент (~150 строк)
├── components/            # UI компоненты
│   ├── Header.tsx         # Заголовок с импортом/экспортом
│   ├── Footer.tsx         # Уведомления об ошибках API
│   ├── ModeSelector.tsx   # Переключение режимов
│   ├── TextInputView.tsx  # Ввод текста и прогресс
│   ├── FlashcardsView.tsx # Изучение карточек
│   ├── ReadingView.tsx    # Интерактивное чтение
│   ├── TranslationView.tsx# Полный перевод
│   └── EditView.tsx       # Редактирование карточек
├── hooks/                 # Кастомные React хуки
│   ├── useProcessing.ts   # Обработка текста и API
│   ├── useFileOperations.ts # Импорт/экспорт данных
│   └── useKeyboardNavigation.ts # Горячие клавиши
├── utils/                 # Утилитарные функции
│   ├── cardUtils.ts       # Работа с карточками
│   └── textUtils.ts       # Обработка текста
└── types/
    └── index.ts           # TypeScript типы и интерфейсы
```

### 4.2 Backend с поддержкой сессий
**Proxy сервер с SSE и состоянием**:
- Express.js с SSE поддержкой + session управление
- CORS middleware
- **Endpoints**:
  - `POST /api/translate/start` - начало/возобновление обработки
  - `GET /api/translate/events/:sessionId` - SSE поток с ID сессии  
  - `POST /api/translate/resume` - восстановление незавершенной сессии
  - `POST /api/translate/pause` - приостановка с сохранением состояния
  - `DELETE /api/translate/session/:sessionId` - очистка сессии
  - `POST /api/claude` - прямое проксирование (fallback)

**Управление сессиями**:
- In-memory хранение активных сессий (Map)
- Автоочистка неактивных сессий (TTL 24 часа)
- Поддержка множественных пользователей

**SSE События**:
```typescript
// Начало обработки
{ type: 'chunks:started', payload: { totalChunks: 10 } }

// Обработан очередной чанк
{ 
  type: 'chunk:translated', 
  payload: { 
    chunkIndex: 2, 
    cards: [...], 
    translationSegment: "...",
    processedSentences: ["..."]
  } 
}

// Завершение обработки
{ type: 'chunks:finished', payload: { totalCards: 45 } }

// Ошибка обработки
{ type: 'chunk:error', payload: { chunkIndex: 5, error: "..." } }
```

**Очередь обработки**:
- Последовательная обработка чанков (НЕ параллельная)
- Задержка 800мс между запросами к Claude API
- Graceful обработка ошибок с продолжением обработки следующих чанков

### 4.3 API интеграция
**Claude API**:
- Модель: Claude-3-5-Sonnet
- Максимум токенов: 1024
- Temperature: 0.7
- Обработка rate limiting
- Многоуровневая обработка ответов

### 4.4 Хранение данных с автосохранением
**Основное хранение**:
- Локальное хранение в состоянии React
- JSON экспорт/импорт для персистентности

**Автосохранение для восстановления**:
- **localStorage** для сохранения прогресса обработки:
  - Ключ: `latvian-learning-session-${sessionId}`
  - Данные: ProcessingState + частичные результаты
  - Обновление каждые 5 обработанных чанков
- **Автоочистка**: удаление старых сессий (>7 дней)
- **Проверка при загрузке**: поиск незавершенных сессий

**Структура localStorage**:
```javascript
{
  sessionId: string,
  timestamp: number,
  inputText: string,
  settings: AppSettings,
  processingState: ProcessingState,
  partialResults: {
    flashcards: Flashcard[],
    translationSegments: string[]
  }
}
```

**Валидация данных**:
- Проверка целостности при восстановлении
- Миграция между версиями приложения
- Fallback на экспорт при критических ошибках

## 5. Пользовательский интерфейс

### 5.1 Дизайн системы
**Цветовая схема**:
- Основной: `#6A9BCC`
- Фон: градиент синего
- Карточки: белый фон с округлыми углами
- Текст: градации серого

**Типографика**:
- Основной шрифт: Noto Sans Display
- Размеры: от 14px до 48px
- Поддержка латышских диакритических знаков

### 5.2 Компоновка
```
[Latvian Language Learning]         [⚙️ settings] [↗ import]
                                                   [↓ export] 

    [Text] [Flashcards] [Reading] [Translation] [Edit] [❌ Clear]

                    [Основное окно контента]
```

**Header элементы**:
- **Settings**: модальное окно с конфигурацией приложения
- **Import/Export**: расширенные с поддержкой настроек
- **Clear**: сброс данных с подтверждением о потере настроек

### 5.3 Состояния интерфейса и стриминговый UX
**Состояния приложения**:
- `input`: ввод текста
- `streaming`: активная обработка чанков с real-time обновлениями
- `ready`: все чанки обработаны, полная функциональность доступна

**Стриминговый пользовательский опыт**:

**Фаза инициализации**:
- Показ прогресс-бара "Переведено 0 из X чанков"
- Статус "Preparing text..." / "Processing chunk 1 of X..."

**Фаза активной обработки**:
- **Прогресс-бар с детализацией**:
  ```
  Processing sentence-by-sentence...
  Chunk 3 of 10 • 30%
  [████████░░░░░░░░░░] 
  ```
- **Постепенная активация режимов**:
  - После первых 2-3 карточек → активация режима Flashcards
  - После первых переводов → активация режима Reading (частично)
  - После первых переводов → активация режима Translation (частично)
  - Режим Edit активен с первых карточек

**Индикаторы real-time обновлений**:
- **Badge с текущим статусом**:
  ```jsx
  {!isFinished && <Badge color="yellow">Processing... {processedChunks}/{totalChunks}</Badge>}
  {isFinished && <Badge color="green">Ready!</Badge>}
  ```
- **Анимированные счетчики**: "Edit Flashcards (15 total)" → "Edit Flashcards (23 total)"
- **Плавное появление новых элементов** с fade-in анимацией

**Обратная связь пользователю**:
- **Кнопка отмены** во время обработки
- **Логирование процесса**: "Chunk 3 completed: +7 cards, +2 sentences"
- **Предупреждения**: "Some chunks failed, but processing continues..."

## 8. Система уведомлений и обработка ошибок API

### 8.1 Компонент Footer для уведомлений
**Описание**: Интеллектуальная система уведомления пользователя о состоянии API и ошибках

**Типы уведомлений:**
- **🔴 Перегрузка сервера (Error 529)**: "Сервер перегружен. Пожалуйста, попробуйте позже."
- **🟡 Недостаток баланса**: "Баланс на API Claude исчерпан. Пожалуйста, пополните план."
- **⚪ Отсутствие соединения**: "Нет соединения с интернетом. Проверьте подключение."
- **🔴 Общие ошибки**: "Произошла ошибка при обработке текста. Попробуйте еще раз."

**Функциональность Footer.tsx:**
- Отображение текущего статуса обработки при debugging
- Показ сообщений об ошибках API в понятном для пользователя виде
- Автоматическое скрытие уведомлений через заданное время
- Цветовая индикация серьезности проблемы

**Логика обработки ошибок:**
```typescript
interface ApiError {
  status: number;
  message: string;
  retryAfter?: number;
}

const handleApiError = (error: ApiError) => {
  switch (error.status) {
    case 529: return "🔴 Сервер перегружен. Попробуйте через несколько минут.";
    case 402: return "🟡 Недостаточно средств на API. Пополните баланс.";
    case 0: return "⚪ Проблемы с интернетом. Проверьте соединение.";
    default: return "🔴 Произошла ошибка. Попробуйте еще раз.";
  }
};
```

### 8.2 Интеграция с системой обработки
- **Автоматическое определение типа ошибки** на основе HTTP статус-кода
- **Fallback механизмы**: при ошибках API показ сохраненных данных
- **Graceful degradation**: приложение остается функциональным при сбоях
- **Retry логика**: автоматические повторные попытки с экспоненциальной задержкой

## 9. Компонентная архитектура

### 9.1 Структура компонентов

**Header.tsx** (~100 строк)
- Отображение заголовка приложения и брендинга
- Кнопки импорта/экспорта данных
- Интеграция с системой файловых операций

**ModeSelector.tsx** (~80 строк)  
- Переключение между 5 режимами работы (Text, Flashcards, Reading, Translation, Edit)
- Визуальная индикация активного режима
- Клавиатурные shortcuts для быстрого переключения

**TextInputView.tsx** (~150 строк)
- Текстовое поле для ввода латышского текста (до 5000 символов)
- Кнопка обработки текста с валидацией
- Отображение прогресса обработки с возможностью отмены
- Индикатор лимита символов

**FlashcardsView.tsx** (~300 строк)
- Отображение карточек с flip-анимацией
- Навигация между карточками (стрелки, клавиатура)
- Показ множественных контекстов для одного слова
- Счетчик прогресса изучения

**ReadingView.tsx** (~200 строк)
- Интерактивное чтение с подсказками при наведении
- Цветовое выделение слов и фраз
- Контекстно-зависимые переводы
- Легенда с объяснением цветовой схемы

**TranslationView.tsx** (~50 строк)
- Отображение полного русского перевода текста
- Составление перевода из обработанных фрагментов
- Чистый интерфейс для чтения

**EditView.tsx** (~150 строк)
- Полноэкранная таблица с пагинацией для редактирования карточек
- Поиск и фильтрация карточек по всем полям
- Массовые операции (скрытие/показ, удаление)
- Автосохранение изменений

**Footer.tsx** (~50 строк)
- Система уведомлений об ошибках API
- Отладочная информация (в dev режиме)
- Статус соединения и обработки

### 9.2 Кастомные хуки

**useProcessing.ts** (~100 строк)
- Основная логика обработки текста через Claude API
- Разбивка на чанки и последовательная обработка
- Объединение дубликатов карточек по base_form
- Управление состояниями (loading, ready, error)

**useFileOperations.ts** (~80 строк) 
- Экспорт данных в JSON формат с метаданными
- Импорт данных с валидацией структуры
- Автосохранение промежуточных результатов
- Поддержка drag&drop для импорта

**useKeyboardNavigation.ts** (~60 строк)
- Глобальные горячие клавиши для навигации
- Управление карточками (← → ↑ ↓)
- Переключение режимов (1-5)
- Скрытие карточек (H)

### 9.3 Утилитарные модули

**cardUtils.ts**
- Функции работы с карточками (создание, объединение, поиск)
- Алгоритмы устранения дубликатов
- Валидация структуры карточек

**textUtils.ts** 
- Обработка латышского текста и разбивка на предложения
- Поиск слов и фраз в тексте (findPhraseAtPosition)
- Highlighting функции для интерактивного чтения
- Работа с диакритическими знаками

### 6.1 Технические ограничения
- Максимальный размер текста: 5000 символов
- Зависимость от Claude API
- Браузерная среда выполнения
- Отсутствие серверного хранения

### 6.2 Языковые ограничения
- Исходный язык: только латышский
- Целевой язык: только русский
- Необходимость API для качественного перевода

## 7. Критерии приемки

### 7.1 Функциональные критерии
✅ Обработка латышского текста с созданием 30+ карточек
✅ Корректная работа всех 5 режимов
✅ Объединение дубликатов карточек по base_form
✅ Множественные контексты в карточках
✅ Контекстно-зависимые подсказки в режиме Reading
✅ Полнофункциональное редактирование карточек
✅ Составной перевод из phrase_translation без дополнительного API запроса
✅ Экспорт/импорт без потери данных
✅ Клавиатурная навигация в режиме Flashcards

### 7.2 Архитектурные критерии
✅ **Модульная архитектура реализована**
✅ **App.tsx сокращен до ~150 строк**
✅ **8 специализированных компонентов созданы**
✅ **3 кастомных хука для бизнес-логики**
✅ **Централизованная система типов**
✅ **Четкое разделение ответственности модулей**

### 7.3 Критерии обработки ошибок API
✅ **Footer компонент с интеллектуальными уведомлениями**
✅ **Обработка ошибки 529 (перегрузка сервера)**
✅ **Понятные сообщения пользователю вместо технических**
✅ **Graceful degradation при сбоях API**
✅ **Автоматическое скрытие уведомлений**

### 7.4 Качественные критерии
✅ Стабильная работа при ошибках API
✅ Плавные анимации и переходы
✅ Интуитивный пользовательский интерфейс
✅ Понятные уведомления о состоянии системы
✅ Корректная обработка латышских символов
✅ Отзывчивость интерфейса во время обработки
✅ Легкость добавления новых функций
✅ Возможность изолированного тестирования компонентов

## 8. Риски и их митигация

### 8.1 Технические риски
**Риск**: Ограничения Claude API (rate limiting)
**Митигация**: Задержки между запросами, обработка ошибок 429, graceful degradation

**Риск**: Обрыв SSE соединения во время обработки
**Митигация**: Автоматическое переподключение, сохранение промежуточного состояния, polling fallback

**Риск**: Некорректный парсинг JSON ответов
**Митигация**: 5-уровневая система парсинга с fallback

**Риск**: Потеря данных при обрыве процесса
**Митигация**: Автосохранение промежуточных результатов, возможность продолжения с последнего чанка

**Риск**: Переполнение памяти при больших текстах
**Митигация**: Ограничение размера чанков (max_completion_tokens: 300), мониторинг использования памяти

### 8.2 UX риски
**Риск**: Пользователь закрывает страницу во время обработки
**Митигация**: Предупреждение о потере прогресса, автоэкспорт промежуточных результатов

**Риск**: Слишком медленная обработка больших текстов
**Митигация**: Возможность изучения первых результатов, четкая индикация прогресса, кнопка отмены

**Риск**: Путаница в объединенных контекстах карточек
**Митигация**: Четкое разделение контекстов визуально, настройка показа одного/всех контекстов

## 9. Этапы разработки

### 9.1 Этап 1: Базовая функциональность (выполнено)
- ✅ Настройка проекта (React + TypeScript + Vite)
- ✅ Базовые компоненты интерфейса
- ✅ Proxy сервер для Claude API
- ✅ Режимы Text, Translation, Flashcards

### 9.2 Этап 2: Продвинутые возможности (выполнено)
- ✅ Режим Reading с интерактивными подсказками
- ✅ Режим Edit с полноэкранной таблицей
- ✅ Система экспорта/импорта
- ✅ Оптимизация обработки ошибок

### 9.3 Этап 3: Стабилизация API и оптимизация (выполнено)
- ✅ Увеличение max_tokens до 4096 в Claude API
- ✅ Новая структура данных с contexts
- ✅ Алгоритм объединения дубликатов карточек
- ✅ Составной перевод из phrase_translation
- ✅ Fallback механизмы уровня 1-5

### 9.4 Этап 4: Архитектурная декомпозиция (выполнено)
- ✅ **Создание централизованной системы типов (types/index.ts)**
- ✅ **Выделение 8 UI компонентов (components/)**
- ✅ **Извлечение 3 кастомных хуков (hooks/)**
- ✅ **Создание утилитарных модулей (utils/)**
- ✅ **Рефакторинг App.tsx до 150 строк**
- ✅ **Система обработки ошибок API в Footer**

### 9.5 Этап 5: Текущие задачи (в процессе)
- 🔄 **Исправление ошибки импорта в ReadingView.tsx**
- 🔄 **Юнит-тестирование всех компонентов и хуков**
- 🔄 **Integration тестирование взаимодействия модулей**
- 🔄 **E2E тестирование пользовательских сценариев**

### 9.6 Этап 6: Будущие улучшения (планируется)
- ⏳ Стриминговая обработка с SSE для real-time обновлений
- ⏳ Система настроек с экспортом конфигурации
- ⏳ Автосохранение прогресса в localStorage
- ⏳ Поддержка других языковых пар
- ⏳ Система интервального повторения (spaced repetition)
- ⏳ Голосовое произношение (TTS) для латышского языка
- ⏳ Тестирование стабильности SSE
- ⏳ Оптимизация производительности для больших текстов
- ⏳ Нагрузочное тестирование Claude API
- ⏳ Пользовательское тестирование UX стриминга

## 10. Поддержка и развитие

### 10.1 Планы развития
**Архитектурные улучшения:**
- Добавление комплексного unit-тестирования для всех компонентов
- Внедрение E2E тестов для критических пользовательских сценариев
- Создание Storybook документации для UI компонентов
- Настройка CI/CD pipeline для автоматического тестирования

**Функциональные улучшения:**
- Стриминговая обработка с SSE для real-time обновлений интерфейса
- Система пользовательских настроек с экспортом конфигурации
- Поддержка других языковых пар (эстонский-русский, литовский-русский)
- Система интервального повторения (spaced repetition) для оптимального запоминания
- Статистика изучения с прогрессом по карточкам и временными графиками
- Темы оформления (светлая/темная) с пользовательскими настройками
- Офлайн режим с кешированием результатов обработки

**UX улучшения:**
- Голосовое произношение слов (TTS для латышского языка)
- Избранные карточки и категоризация сложных слов
- Группировка карточек по темам и уровням сложности
- Экспорт в Anki с сохранением контекстов и форматирования
- Адаптивный дизайн для мобильных устройств
- Поддержка drag&drop для импорта файлов

**Техническая оптимизация:**
- Виртуализация больших списков карточек для производительности
- Lazy loading компонентов для уменьшения initial bundle size
- Service Worker для кеширования и офлайн функциональности
- WebAssembly модули для быстрой обработки больших текстов

### 10.2 Техническое обслуживание
- Мониторинг работы API
- Обновление зависимостей
- Резервное копирование пользовательских данных
- Оптимизация производительности

---

## 10. Техническая документация

### 10.1 Структура проекта
```
client/src/
├── App.tsx                 # Главный компонент приложения (~150 строк)
├── types/
│   └── index.ts           # TypeScript типы и интерфейсы
├── components/            # React компоненты пользовательского интерфейса
│   ├── Header.tsx         # Заголовок с импортом/экспортом
│   ├── Footer.tsx         # Уведомления об ошибках API
│   ├── ModeSelector.tsx   # Переключение режимов
│   ├── TextInputView.tsx  # Ввод текста и прогресс
│   ├── FlashcardsView.tsx # Изучение карточек
│   ├── ReadingView.tsx    # Интерактивное чтение
│   ├── TranslationView.tsx# Полный перевод
│   └── EditView.tsx       # Редактирование карточек
├── hooks/                 # Кастомные React хуки
│   ├── useProcessing.ts   # Обработка текста и API
│   ├── useFileOperations.ts # Импорт/экспорт данных
│   └── useKeyboardNavigation.ts # Горячие клавиши
└── utils/                 # Утилитарные функции
    ├── cardUtils.ts       # Работа с карточками
    └── textUtils.ts       # Обработка текста
```

### 10.2 Ключевые улучшения архитектуры
- **Сокращение сложности**: App.tsx с 2400+ строк до 150 строк
- **Модульность**: Каждый компонент отвечает за одну задачу
- **Типизация**: 100% покрытие TypeScript типами
- **Тестируемость**: Изолированные компоненты и хуки легко тестировать
- **Переиспользование**: Компоненты можно использовать в других проектах
- **Поддержка**: Легкое добавление новых функций без затрагивания других модулей

### 10.3 Система обработки ошибок
- **Многоуровневая система**: от UI уведомлений до логирования
- **Понятность пользователю**: технические ошибки переводятся в понятные сообщения
- **Восстановление**: возможность продолжения работы после ошибок
- **Отладка**: специальные режимы для разработчиков

### 10.4 Миграция от монолитной архитектуры
**Процесс декомпозиции проводился поэтапно:**
1. **Этап 1**: Создание типов и интерфейсов (types/index.ts)
2. **Этап 2**: Выделение UI компонентов (components/)
3. **Этап 3**: Извлечение бизнес-логики в хуки (hooks/)
4. **Этап 4**: Создание утилитарных функций (utils/)
5. **Этап 5**: Рефакторинг главного компонента (App.tsx)
6. **Этап 6**: Тестирование и отладка

**Результаты миграции:**
- ✅ 94% сокращение размера основного файла
- ✅ Полное сохранение функциональности
- ✅ Улучшение производительности и отзывчивости
- ✅ Подготовка к unit и integration тестированию

## 6. Ограничения проекта

### 11.1 Проблема дубликатов карточек - РЕШЕНА
**Проблема**: Слова типа "Anna", "mamma/mammai/mammu" создавали дублирующиеся карточки из разных предложений

**Решение**: 
- Группировка карточек по `base_form`
- Одна карточка содержит массив `contexts[]` со всеми случаями использования
- Настраиваемое количество контекстов в карточках (1, 2, 3... или все)
- В режиме Reading - точный поиск перевода по контексту предложения

### 11.2 Стриминговая обработка - НОВАЯ АРХИТЕКТУРА
**Проблема**: Пользователь ждет окончания всей обработки, чтобы начать изучение

**Решение**:
- SSE для real-time обновлений от сервера
- Постепенная активация режимов по мере обработки чанков
- Context API + useReducer для управления потоком данных
- Возможность изучения первых карточек пока обрабатываются остальные

### 11.3 Оптимизация переводов - УСТРАНЕНИЕ ДУБЛИРОВАНИЯ
**Проблема**: Отдельный запрос на полный перевод текста дублирует уже переведенные предложения

**Решение**:
- Склеивание `phrase_translation` из всех контекстов
- Экономия API вызовов и времени
- Более быстрое получение результата

### 11.4 Система настроек - ГИБКОСТЬ И ПЕРСОНАЛИЗАЦИЯ
**Новое решение**: Комплексная система настроек с экспортом

**Возможности**:
- **Поэтапное развитие чанкирования**: сначала 2-3 предложения, потом динамическое по токенам
- **Настраиваемые контексты**: выбор количества показываемых контекстов в карточках
- **Экспорт настроек**: сохранение пользовательских предпочтений
- **Автосохранение**: периодическое сохранение прогресса

### 11.5 Восстановление сессий - НАДЕЖНОСТЬ
**Новое решение**: Система восстановления незавершенной обработки

**Возможности**:
- **Автосохранение прогресса** каждые 5 чанков в localStorage
- **Обнаружение незавершенных сессий** при загрузке приложения
- **Graceful recovery**: продолжение с последнего успешного чанка
- **Повторная обработка** неудачных чанков с backoff стратегией

### 11.6 Техническая реализация
- **Разбиение на чанки**: этап 1 - 2 предложения, этап 2 - по токенам (max 300)
- **Обработка**: последовательная с задержкой 800мс между запросами  
- **События SSE**: `session:started`, `chunk:completed`, `session:finished`
- **Сессии**: уникальные ID, TTL, автоочистка
- **Fallback**: localStorage автосохранение + graceful degradation

---

**Версия документа**: 3.0  
**Дата обновления**: 06.07.2025  
**Изменения**: 
- v2.0: Учтены решения из artifact_chat4.txt - стриминговая обработка, объединение дубликатов, оптимизация переводов
- v3.0: Добавлены система настроек, поэтапное развитие чанкирования, восстановление сессий